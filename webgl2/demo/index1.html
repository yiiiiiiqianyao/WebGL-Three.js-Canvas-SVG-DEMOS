<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body>
    <canvas id="canvas" width="800px" height="400px"></canvas>
</body>
<script>
    const canvas = document.getElementById('canvas');
    canvas.width = 800;
    canvas.height = 400;
    const gl = canvas.getContext( 'webgl2', { antialias: true } );
    // console.log(gl.getParameter(gl.ALIASED_POINT_SIZE_RANGE))

    const positions = new Float32Array([
        -1.0, -1.0,
         1.0, -1.0,
         1.0,  1.0,
         1.0,  1.0,
        -1.0,  1.0,
        -1.0, -1.0
    ]);
    const texCoords = new Float32Array([
        0.0, 1.0,
        1.0, 1.0,
        1.0, 0.0,
        1.0, 0.0,
        0.0, 0.0,
        0.0, 1.0
    ]);
    const matrix = new Float32Array([
        0.5, 0.0, 0.0, 0.0,
        0.0, 0.5, 0.0, 0.0,
        0.0, 0.0, 0.5, 0.0,
        0.0, 0.0, 0.0, 1.0
    ]);

    function createShader(gl, source, type) {
        var shader = gl.createShader(type);
        gl.shaderSource(shader, source);
        gl.compileShader(shader);
        return shader;
    }

    // -- Init program
    

    var program = gl.createProgram();
    var vshader = createShader(gl, getVSHADER(), gl.VERTEX_SHADER);
    var fshader = createShader(gl, getFSHADER(), gl.FRAGMENT_SHADER);
    gl.attachShader(program, vshader);
    gl.attachShader(program, fshader);
    
    gl.linkProgram(program);
    

    var mvpLocation = gl.getUniformLocation(program, 'MVP');

    // -- Init buffers: vec2 Position, vec2 Texcoord
    
    var vertexPosBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, vertexPosBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);
    gl.bindBuffer(gl.ARRAY_BUFFER, null);


    var vertexTexBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, vertexTexBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, texCoords, gl.STATIC_DRAW);
    gl.bindBuffer(gl.ARRAY_BUFFER, null);

    // -- Init VertexArray
    var vertexArray = gl.createVertexArray();
    gl.bindVertexArray(vertexArray);

    var vertexPosLocation = 0; // set with GLSL layout qualifier
    gl.enableVertexAttribArray(vertexPosLocation);
    gl.bindBuffer(gl.ARRAY_BUFFER, vertexPosBuffer);
    gl.vertexAttribPointer(vertexPosLocation, 2, gl.FLOAT, false, 0, 0);
    gl.bindBuffer(gl.ARRAY_BUFFER, null);

    // var texcoordPosition = gl.getAttribLocation(program, "texcoord") // 通常 webgl1 需要获取 attribute 对应参数的位置
    // console.log('texcoordPosition', texcoordPosition) // 4

    var vertexTexLocation = 4; // set with GLSL layout qualifier
    gl.enableVertexAttribArray(vertexTexLocation);
    gl.bindBuffer(gl.ARRAY_BUFFER, vertexTexBuffer);
    gl.vertexAttribPointer(vertexTexLocation, 2, gl.FLOAT, false, 0, 0);
    gl.bindBuffer(gl.ARRAY_BUFFER, null);

    gl.bindVertexArray(null);

  
    // -- Render
    gl.useProgram(program)
    gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);

    gl.clearColor(0.0, 0.0, 0.0, 1.0);
    gl.clear(gl.COLOR_BUFFER_BIT);

    gl.uniformMatrix4fv(mvpLocation, false, matrix);
    

    gl.bindVertexArray(vertexArray);

    gl.drawArrays(gl.TRIANGLES, 0, 6);

    
    gl.deleteBuffer(vertexPosBuffer);
    gl.deleteBuffer(vertexTexBuffer);
    
    gl.deleteProgram(program);
    gl.deleteVertexArray(vertexArray);
    


function getVSHADER () {
    return `#version 300 es
    #define POSITION_LOCATION 0
    #define TEXCOORD_LOCATION 4
    
    precision highp float;
    precision highp int;

    uniform mat4 MVP;

    layout(location = POSITION_LOCATION) in vec2 position;
    layout(location = TEXCOORD_LOCATION) in vec2 texcoord;

    out vec2 v_st;

    void main()
    {
        v_st = texcoord;
        gl_Position = MVP * vec4(position, 0.0, 1.0);
    }
    `.replace(/^\s+|\s+$/g, '')
}

function getFSHADER () {
    return ` #version 300 es
    precision highp float;
    precision highp int;

    in vec2 v_st;

    out vec4 color;

    void main()
    {
        color = vec4(v_st, 0.0, 1.0);
    }`
}

</script>

</html>
